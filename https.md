# 来由

使用charles抓包时解决https协议的问题

# Https原理

## HTTP的缺点

* 通信使用明文，内容可能会被监听
* 不验证通信方的身份，因此有可能遭遇伪装
* 无法证明报文的完整性，所以有可能已经被篡改


1. 使用TLS/SSL给传输层加密，或者对内容加密，但是仅仅对内容加密仍然有被篡改的风险
2. HTTP协议中的请求和响应不会对通信方进行确认，可能会有服务器伪装成我们要访问的服务器从而窃取发送的隐私信息，又或者有无意义的请求服务器也会照单全收，无法阻止海量请求下的DoS攻击。SSL不仅可以提供加密的通信，而且还提供了一种被称为证书的手段。
3. 请求或响应在传输途中被拦截并篡改内容叫做中间人攻击（MITM）。如何防止篡改呢，SSL也可以，它提供加密、认证和摘要功能，可以解决以上三个问题。

SSL是位于应用层和传输层中间的一层网络安全协议，使得应用层和TCP/UDP间接通信。

SSL采用公开密钥加密的加密技术，是对称加密，传输密钥的时候依然有被盗取的风险。

公开密钥加密方式可以很好的解决这个问题，通信方先将自己的公开密钥发送给对方，接受到对方的消息之后再使用私钥解密，防止路径中间的信息被盗取。

## 混合加密

HTTPS采用混合加密的形式

客户端发送信息给服务器为例

**用公钥加密方式传输共享密钥加密方式的密钥**

1. 服务器发送公钥给客户端。
2. 客户端用服务器的公钥给共享密钥加密。
3. 客户端将加密后的共享密钥发送给服务端。
4. 服务端用私钥解密出共享密钥。

**双方使用共享密钥加密的方式进行数据传输**

服务端收到共享密钥之后两段就可以对称加密的形式通信了。

## 公开密钥的问题

需要证明公开密钥就是合法的公开密钥。

使用认证机构的公开密钥解密带证书的服务端公钥，可以得出两个结论

1. 服务端是合法的。
2. 服务端公钥是没有被篡改过的。

为了保护认证机构的公钥传输，浏览器会嵌入常用认证机构的公钥。

# HTTPS的安全通信机制

1. 客户端发送CientHello报文开始SSL通信。报文中包含客户端支持的SSL版本、加密组件列表。
2. 服务器可进行SSL通信时，会以ServerHello报文作为回应。内容和客户端一样，包含SSL版本和加密组件，是从ClientHello中筛选出来的。
3. 服务器发送Certificate报文，包含公开密钥证书。
4. 服务器发送Server Hello Done报文通知客户端，SSL第一次握手阶段结束。

5. 客户端发送Client Key Exchange报文，包含一个Pre-master secret密码串，使用步骤三的公钥加密过的。
6. 客户端发送Change Cipher Spec报文，提示服务器之后的通信采用Pre-master secret密钥加密
7. 客户端发送Finished报文

8. 服务器发送Change Cipher Spec报文
9. 服务器发送Finished报文

10. Finished交换完毕之后SSL建立完成

11. HTTP通信
12. 断开连接