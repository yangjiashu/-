# 1 DM安装和卸载

## 1.1 Linux下DM的安装与卸载

### 1.1.1 安装前的准备工作

支持的系统：

* Linux
* AIX
* HP-UNIX
* Solaris
* FreeBSD
  
命令

**检查系统信息**

* `gpg --import dm-pub-key`:导入公钥
* `gpg --edit-key 武汉达梦数据库有限公司 strust`:将公钥添加到信任列表
* `gpg --verify dm.sign dm8_setup_xxx.iso`:验证签名，如果输出“完好的签名”，则表示安装包无损且安全

* `getconf LONG_BIT`:获取系统位数
* `lsb_release -a`:查询操作系统release信息
* `cat /etc/issue`:查询系统信息
* `uname -a`:查询系统名称

**创建安装用户**

不应该用root来安装和运行DM。可以为DM创建一专用的系统用户。

* `groupadd -g 12349 dinstall`:创建安装用户组dinstall
* `useradd -u 12345 -g dinstall -m -d /home/dmdba -s /bin/bash dmdba`:创建安装用户dmdba
* `passwd dmdba`:初始化用户密码

**查看操作系统限制**

`ulimit -a`可以查看操作系统限制

* `data seg size`建议设置为1048576（1GB）以上或者unlimited
* `file size`建议设置为unlimited
* `open files`建议设置为65536以上或者unlimited
* `virtual memory`建议设置为1GB以上或unlimited

如果需要修改，则修改配置文件/etc/security/limits.conf

# 配置和创建DM数据库

通过数据库配置工具或dminit来手工创建数据库。创建完成后，可以通过查询V$DM_INI动态视图查看建库参数

## 创建数据库

1. 指定数据库目录
2. 制定数据库标识（数据库名，实例名，端口号）
3. 数据库文件
   * 控制文件(dm.ctl),与配置文件类似，对系统的运行及性能有很大影响，但是配置文件一般可以修改，而控制文件一般在系统第一次创建完成之后就不能随意修改。整个系统只有一个控制文件，其中存储的主要包括<u>数据文件路径</u>、<u>日志文件路径</u>、<u>LSN信息等</u>。
   * 数据文件,<u>指定系统表路径</u>、<u>用户表空间路径</u>、<u>回滚表空间路径</u>和<u>临时表空间路径</u>，是数据最终要存储的地方，<u>数据页</u>是系统进行磁盘IO和缓冲区调度的来本单元。<u>簇</u>是数文件中一个连续的分配空间，由多个数量固定的数据页组成
   * 日志文件,用于存储数据库的事务日志
   * 初始化日志，指定初始化过程中生成的日志文件所在的路径
4. 初始化参数

   * 簇大小：16,32,64,默认16
   * 页大小：4K,8K,16K,32K,默认8K
   * 时区：默认+08:00,范围在[-12:59, +14:00]
   * 页面检查：不启用、简单检查、严格检查，默认不启用
   * 字符集：GB18030(默认), Unicode, EUC-KR
5. 口令管理
   * 为SYSDBA和SYSAUDITOR设置口令密码，默认为用户名（大写）

# 启动和关闭数据库

## 数据库状态和模式

包含以下几种状态

1. 配置状态（MOUNT）：不允许访问数据库对象，只能进行控制文件维护、归档配置、数据库模式修改等操作
2. 打开状态（OPEN）：与配置状态相反
3. 挂起状态（SUSPEND）：与OPEN的唯一区别是，限制磁盘写入功能

包含以下几种模式

1. 普通模式（NORMAL）：操作没有限制
2. 主库模式（PRIMARY）：对数据库对象的修改强制生成REDO日志，在归档有效时，发送REDO日志到备库
3. 备库模式（STANDBY）：接收主库发送过来的REDO日志并重做，数据对用户只读

三种模式只能在MOUNT状态下设置

# DM逻辑结构

## 数据库和实例

# 题目

## 备份

备份的过程中，数据库操作并不会立即体现在数据文件中，而是首先以日志的形式写到归档日志中，因此，要通过备份集将数据恢复到备份结束时间点，还需要将归档日志也保存到备份集中。

**还原**是将备份集中的有效数据页写入目标数据文件的过程，**恢复**是通过重做归档日志，将数据状态恢复到备份结束时的状态。

## 物理备份实战

* OPEN状态支持备份、还原和回复操作
* MOUNT状态支持归档备份
* SUPEND状态均不支持

准备工作

归档配置，通过dm.ini和dmarch.ini可以配置本地贵点给，dmarch.ini生效的前提是dm.ini的参数ARCH_INI设置为1，DM备份与还原过程中使用的日志均为本地归档日志。

在归档模式下，不允许删除本地归档

归档配置有两种方式:

1. 联机：`alter database <add|modify|delete> archivelog <>;...`, `alter database archivelog | noarchivelog;`
2. 脱机：配置dm.ini文件，再配置dmarch.ini文件

完整

```
alter database mount; -- 修改数据库为mount状态
alter database add archivelog 'dest = /home/dm_arch/arch, type = local, file_size = 1024, space_limit = 2048'; -- 配置本地归档
alter database archivelog; -- 开启归档模式
alter database open; -- 修改数据库为open状态
```

备份

1. 联机：用SQL语句执行备份操作
2. 脱机：

联机执行过程

`backup database ...`

* `FULL`: 备份类型，FULL表示完全备份，不指定默认完全备份
* `INCREMENT`: 备份类型，表示增量备份
* `CUMULATIVE`: 用于增量备份中，指明为累计增量备份类型，若不指定则缺省为差异增量备份。
* `with backupdir`: 用于增量备份，制定基备份的搜索目录
* `base on`: 用于增量备份中，制定基备份集目录
* `to`: 制定生成备份名称
* `backupset`: 制定当前备份集生成路径

* 系统处于归档模式下，才允许进行数据库联机备份。
* MOUNT状态下不允许进行数据库备份。

